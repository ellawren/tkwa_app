<%= form_for @project do |f| %>

	<%= render 'project_header', f: f %>
	
	<% date = Date.today %>

	<h2>Tracking</h2>
	<% if @project.employee_teams.length == 0 || @project.phases.length == 0 %>
		<p class="description">This project's team has not been set up yet. Click the 'team' tab in the bar above to add team members.</p>
	<% else %>
		<p class="description">The table below compares actual hours as entered on timesheets with target hours as determined by our fee. Staying under the target will keep a project profitable, while going over (shown in <span class="bold over">red</span>) represents a net loss.</p>

		<table class="table tracking-table">
			<thead>
                <tr>
                    <th class="bold">Team Member</th>
                    <th class="smalltext"></th>
                    <% @project.available_phases.each do |phase| %>
                    	<th class="table-cell"><%= phase.number %><br /><span class="name"><%= phase.name %></span></th>
                    <% end %>
                    <th class="total-hours">Total</th>
                    <th class="remaining">% Used</th>
                </tr>
            </thead>
			<tbody>
				<% @employee_teams.each do |team| %>
		    		<tr>
		    			<td class="tname"><a href="<%= edit_project_employee_team_path(team.project_id, team.id) %>" data-target="#myModal" data-toggle="modal" class="modal-btn edit-targets"><%= team.user.name %></a>
		    				<div class="role">
		    					$<%= strip(team.rate) %>/hr
		    				</div>
		    			</td>
		    			<td class="labels">
							<div class="target">target</div>
							<div class="actual">actual</div>
						</td>

						<% @project.available_phases.each do |phase| %>
			                <td class="phase-cell">
			                	<% est_hours = eval("team.#{phase.shorthand}_hours") %>
							    <div class="target"><%= est_hours %></div>
			                    <div class="actual <%= is_over?(eval("team.#{phase.shorthand}_hours"), team.employee_actual(phase.number)  ) %>">
			                    	<%= nonzero(team.employee_actual(phase.number)) %>
			                    </div>
			                </td>
			            <% end %>

			            <td class="total-hours">
			            	<div class="target">
								<%= nonzero(team.est_total) %>
							</div>
							<div class="actual <%= is_over?(team.est_total, team.employee_actual('Total')) %>">
								<%= nonzero(team.employee_actual('Total')) %>
							</div>
						</td>
						<td class="remaining">
							<% unless team.est_total == 0 %>
								<div class="percent-used <%= is_over?(team.est_total, team.employee_actual('Total')) %>">
									<% if team.percent_used > 999 %>
							            !
							        <% else %>
							            <%= number_to_percentage(team.percent_used, :precision => 0) %>
							        <% end %>
								</div>
							<% end %>
						</td>
		    		</tr>
		    	<% end %>
			</tbody>
			<tfoot>
				<tr class="est-hours">
					<td>Target Hours</td>
					<td></td>
					<% @project.available_phases.each do |phase| %>
						<td class="phase-cell"><%= nonzero(@project.phase_est(phase.shorthand)) %></td>
					<% end %>
					<td class="total-hours"><%= nonzero(@project.sum_est) %></td>
					<td></td>
				</tr>
				<tr class="actual">
					<td class="tname">Actual Hours</td>
					<td class="labels">
					</td>
					<% @project.available_phases.each do |phase| %>
						<td class="phase-cell">
							<div class="actual-hours <%= is_over?(@project.phase_est("#{phase.shorthand}"), @project.phase_actual('#{phase.number}')) %>">
								<%= nonzero(@project.phase_actual("#{phase.number}")) %>
							</div>
						</td>
					<% end %>
					<td class="total-hours">
						<div class="actual-total <%= is_over?(@project.sum_est, @project.sum_actual) %>">
							<%= nonzero(@project.sum_actual) %>
						</div>
					</td>
					<td class="remaining"></td>
				</tr>
				<tr class="est-fees">
					<td>Target Fees</td>
					<td></td>
					<% @project.available_phases.each do |phase| %>
						<td class="phase-cell"><%= nonzero_currency(@project.target_billing_total(phase.number)) %></td>
					<% end %>
					<td class="total-hours"><%= nonzero_currency(@project.target_billing_total('Total')) %></td>
					<td></td>
				</tr>
				<tr class="actual">
					<td class="tname">Actual Fee<br><div class="italic">% of Target Total</div></td>
					<td class="labels">
					</td>

					<% @project.available_phases.each do |phase| %>
						<td class="phase-cell">
							<div class="actual-hours <%= is_over?(@project.phase_est("#{phase.shorthand}"), @project.phase_actual('#{phase.number}')) %>">
								<%= nonzero_currency(@project.actual_billing_total(phase.number)) %>
								<br>
								<div class="italic"><%= nonzero_percentage(@project.percentage_of_total("#{phase.number}")) %></div>
							</div>
						</td>
					<% end %>
					
					<td class="total-hours">
						<div class="actual-total <%= is_over?(@project.sum_est, @project.sum_actual) %>">
							<%= nonzero_currency(@project.actual_billing_total('Total')) %>
							<br>
							<div class="italic"><%= nonzero_percentage(@project.percentage_of_total('Total')) %></div>
						</div>
					</td>

					<td class="remaining"></td>
					
				</tr>
			</tfoot>
		</table>

		<div class="full">
			<div class="tracking-summary">
				<div class="circle billing">
					<div class="text">TKWA Fee<br>(from billing)</div>
					<div class="number"><%= number_to_currency(@project.tkwa_fee, :precision => 0) %></div>
				</div>
				<div class="circle">
					<div class="text">Target Fee<br>(based on hours)</div>
					<div class="number"><%= number_to_currency(@project.target_billing_total('Total'), :precision => 0) %></div>
				</div>
				<div class="minus"></div>
				<div class="circle">
					<div class="text">Actual Fee<br>(Hours To Date)</div>
					<div class="number"><%= number_to_currency(@project.actual_billing_total('Total'), :precision => 0) %></div>
				</div>
				<div class="equals"></div>
				<div class="circle <%= is_over?(@project.target_billing_total('Total'), @project.actual_billing_total('Total')) %>">
					<div class="text"><br>Remainder</div>
					<div class="number"><%= remaining_currency(@project.target_billing_total('Total'), @project.actual_billing_total('Total')) %></div>
				</div>
				<div class="circle billing">
					<div class="text"><br>project is</div>
					<div class="number"><%= @project.project_status %></div>
				</div>
			</div>

		</div>

	<% end %>

<% end %>

<!-- modal for employee target edit -->
    <div class="modal hide fade team-tracking" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"></div><!-- /.modal -->
<!-- end modal -->

<% content_for :scripts do %>
    <script>
    //reset modal remote on close
    $('#myModal').on('hide.bs.modal', function (e) {
        $(this).data('bs.modal', null);
    });
    </script>
<% end %>